DROP VIEW IF EXISTS `WINWATCH`;
DROP VIEW IF EXISTS `SERCHIO`;
DROP VIEW IF EXISTS `BADGES`;

CREATE VIEW `WINWATCH` AS
SELECT Centrale,Data,evento,messaggio,contatore FROM WIN_REPORT
LEFT JOIN WIN_EVENTI USING(id_evento)
LEFT JOIN WIN_MESSAGGI USING(id_messaggio)
ORDER BY Data DESC;

CREATE VIEW `SERCHIO` AS
SELECT Data,centrale,seriale,evento,CONCAT(COALESCE(varco,''),' ',COALESCE(direzione,'')) AS Messaggio,nome AS Ospite,contatore 
FROM SER_REPORT
LEFT JOIN SER_TESSERE USING(id_tessera)
LEFT JOIN SER_EVENTI USING(id_evento)
LEFT JOIN SER_VARCHI USING(id_varco)
LEFT JOIN SER_OSPITI USING(id_ospite)
ORDER BY Data DESC;

CREATE VIEW `BADGES` AS
SELECT CONCAT_WS(' ',
CASE tipo WHEN 1 THEN (SELECT 'ESTERNI') WHEN 2 THEN (SELECT 'POSTE') ELSE (SELECT 'SCONOSCIUTO') END,
IF(NULLIF(numero,NULL),(SELECT CONCAT('numero ',numero)),NULL),
'con',seriale) AS Badges
FROM SER_TESSERE
WHERE seriale<>''
ORDER BY tipo DESC,LENGTH(numero),numero;